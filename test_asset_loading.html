<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Loading Error Handling Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f0f23;
            color: #00ff41;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #00ff41;
            border-radius: 5px;
        }
        
        .test-button {
            background: #00ff41;
            color: #0f0f23;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .test-button:hover {
            background: #00cc33;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid #00ff41;
        }
        
        .error-result {
            background: rgba(220, 20, 60, 0.1);
            border-left-color: #dc143c;
            color: #dc143c;
        }
        
        .success-result {
            background: rgba(0, 255, 65, 0.1);
            border-left-color: #00ff41;
            color: #00ff41;
        }
        
        #test-image {
            max-width: 300px;
            max-height: 200px;
            border: 2px solid #00ff41;
            margin: 10px 0;
        }
        
        .loading-indicator {
            display: none;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <h1>üß™ Asset Loading Error Handling Test</h1>
    <p>This page tests the asset loading error handling system for the Nadine Vuan game.</p>

    <div class="test-section">
        <h2>üì∑ Image Loading Tests</h2>
        <button class="test-button" onclick="testValidImage()">Test Valid Image</button>
        <button class="test-button" onclick="testInvalidImage()">Test Invalid Image</button>
        <button class="test-button" onclick="testSlowImage()">Test Slow Loading Image</button>
        <button class="test-button" onclick="testFallbackChain()">Test Fallback Chain</button>
        
        <div class="loading-indicator" id="image-loading">Loading image...</div>
        <img id="test-image" alt="Test Image" style="display: none;">
        <div id="image-result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Data Loading Tests</h2>
        <button class="test-button" onclick="testValidData()">Test Valid Data</button>
        <button class="test-button" onclick="testInvalidData()">Test Invalid Data</button>
        <button class="test-button" onclick="testNetworkTimeout()">Test Network Timeout</button>
        <button class="test-button" onclick="testFallbackData()">Test Fallback Data</button>
        
        <div class="loading-indicator" id="data-loading">Loading data...</div>
        <div id="data-result"></div>
    </div>

    <div class="test-section">
        <h2>üåê Network Status Tests</h2>
        <button class="test-button" onclick="testNetworkMonitor()">Test Network Monitor</button>
        <button class="test-button" onclick="simulateOffline()">Simulate Offline</button>
        <button class="test-button" onclick="simulateSlowConnection()">Simulate Slow Connection</button>
        
        <div id="network-result"></div>
    </div>

    <div class="test-section">
        <h2>üìà Asset Loading Statistics</h2>
        <button class="test-button" onclick="showLoadingStats()">Show Loading Stats</button>
        <div id="stats-result"></div>
    </div>

    <script type="module">
        import { AssetLoader } from './src/modules/AssetLoader.js';
        import { ErrorHandler } from './src/modules/ErrorHandler.js';
        import { NetworkMonitor } from './src/modules/NetworkMonitor.js';

        // Create mock game controller for testing
        const mockGameController = {
            gameState: { gameData: null },
            uiManager: {
                showFeedbackMessage: (message, type, options) => {
                    console.log(`Feedback: [${type}] ${message}`, options);
                    showResult('network-result', message, type === 'error' ? 'error' : 'success');
                }
            }
        };

        // Initialize test components
        const errorHandler = new ErrorHandler(mockGameController);
        const assetLoader = new AssetLoader(errorHandler);
        const networkMonitor = new NetworkMonitor(mockGameController.uiManager);

        // Make functions globally available
        window.testValidImage = async function() {
            showLoading('image-loading', true);
            showResult('image-result', 'Testing valid image loading...', 'info');
            
            try {
                const image = await assetLoader.loadImage('../assets/scenes/world_map.png', 'scene');
                document.getElementById('test-image').src = image.src;
                document.getElementById('test-image').style.display = 'block';
                showResult('image-result', '‚úÖ Valid image loaded successfully!', 'success');
            } catch (error) {
                showResult('image-result', `‚ùå Failed to load valid image: ${error.message}`, 'error');
            } finally {
                showLoading('image-loading', false);
            }
        };

        window.testInvalidImage = async function() {
            showLoading('image-loading', true);
            showResult('image-result', 'Testing invalid image with fallback...', 'info');
            
            try {
                const image = await assetLoader.loadImage('../assets/scenes/nonexistent_image.png', 'scene');
                document.getElementById('test-image').src = image.src;
                document.getElementById('test-image').style.display = 'block';
                showResult('image-result', '‚úÖ Invalid image handled with fallback!', 'success');
            } catch (error) {
                showResult('image-result', `‚ùå Fallback also failed: ${error.message}`, 'error');
            } finally {
                showLoading('image-loading', false);
            }
        };

        window.testSlowImage = async function() {
            showLoading('image-loading', true);
            showResult('image-result', 'Testing slow loading image (timeout test)...', 'info');
            
            try {
                // Use a large image with short timeout to simulate slow loading
                const image = await assetLoader.loadImage('../assets/scenes/world_map.png?slow=true', 'scene', {
                    timeout: 100 // Very short timeout to trigger timeout handling
                });
                document.getElementById('test-image').src = image.src;
                document.getElementById('test-image').style.display = 'block';
                showResult('image-result', '‚úÖ Image loaded (faster than expected)', 'success');
            } catch (error) {
                showResult('image-result', `‚è±Ô∏è Timeout handled correctly: ${error.message}`, 'success');
            } finally {
                showLoading('image-loading', false);
            }
        };

        window.testFallbackChain = async function() {
            showLoading('image-loading', true);
            showResult('image-result', 'Testing fallback chain...', 'info');
            
            try {
                // Test with multiple invalid paths to trigger fallback chain
                const image = await assetLoader.loadImage('../invalid/path/image.png', 'city_scene');
                document.getElementById('test-image').src = image.src;
                document.getElementById('test-image').style.display = 'block';
                showResult('image-result', '‚úÖ Fallback chain worked! Check image source.', 'success');
            } catch (error) {
                showResult('image-result', `‚ùå Fallback chain failed: ${error.message}`, 'error');
            } finally {
                showLoading('image-loading', false);
            }
        };

        window.testValidData = async function() {
            showLoading('data-loading', true);
            showResult('data-result', 'Testing valid data loading...', 'info');
            
            try {
                const data = await assetLoader.loadGameData('../assets/data/game_data.json');
                showResult('data-result', `‚úÖ Data loaded successfully! Found ${data.game_data?.cities?.length || 0} cities.`, 'success');
            } catch (error) {
                showResult('data-result', `‚ùå Failed to load data: ${error.message}`, 'error');
            } finally {
                showLoading('data-loading', false);
            }
        };

        window.testInvalidData = async function() {
            showLoading('data-loading', true);
            showResult('data-result', 'Testing invalid data with fallback...', 'info');
            
            try {
                const data = await assetLoader.loadGameData('../invalid/path/data.json');
                showResult('data-result', `‚úÖ Invalid data handled! Using fallback with ${data.game_data?.cities?.length || 0} cities.`, 'success');
            } catch (error) {
                showResult('data-result', `‚ùå Fallback data failed: ${error.message}`, 'error');
            } finally {
                showLoading('data-loading', false);
            }
        };

        window.testNetworkTimeout = async function() {
            showLoading('data-loading', true);
            showResult('data-result', 'Testing network timeout...', 'info');
            
            try {
                const data = await assetLoader.loadGameData('../assets/data/game_data.json', {
                    timeout: 1 // Very short timeout
                });
                showResult('data-result', '‚úÖ Data loaded faster than timeout', 'success');
            } catch (error) {
                showResult('data-result', `‚è±Ô∏è Timeout handled correctly: ${error.message}`, 'success');
            } finally {
                showLoading('data-loading', false);
            }
        };

        window.testFallbackData = async function() {
            showLoading('data-loading', true);
            showResult('data-result', 'Testing fallback data creation...', 'info');
            
            try {
                const fallbackData = assetLoader.createFallbackGameData();
                showResult('data-result', `‚úÖ Fallback data created! Contains ${fallbackData.game_data.cities.length} emergency cities.`, 'success');
            } catch (error) {
                showResult('data-result', `‚ùå Fallback creation failed: ${error.message}`, 'error');
            } finally {
                showLoading('data-loading', false);
            }
        };

        window.testNetworkMonitor = function() {
            const status = networkMonitor.getNetworkStatus();
            showResult('network-result', 
                `Network Status: ${status.isOnline ? 'Online' : 'Offline'}, Quality: ${status.connectionQuality}`, 
                status.isOnline ? 'success' : 'error'
            );
        };

        window.simulateOffline = function() {
            // Simulate offline event
            window.dispatchEvent(new Event('offline'));
            showResult('network-result', 'Simulated offline event triggered', 'info');
        };

        window.simulateSlowConnection = function() {
            // This would normally be detected automatically
            showResult('network-result', 'Slow connection simulation would be detected automatically during asset loading', 'info');
        };

        window.showLoadingStats = function() {
            const stats = assetLoader.getLoadingStats();
            const networkStatus = networkMonitor.getNetworkStatus();
            
            const statsHtml = `
                <strong>Asset Loading Statistics:</strong><br>
                ‚Ä¢ Loaded: ${stats.loaded}<br>
                ‚Ä¢ Failed: ${stats.failed}<br>
                ‚Ä¢ Currently Loading: ${stats.loading}<br>
                ‚Ä¢ Success Rate: ${stats.successRate.toFixed(1)}%<br>
                <br>
                <strong>Network Status:</strong><br>
                ‚Ä¢ Online: ${networkStatus.isOnline}<br>
                ‚Ä¢ Quality: ${networkStatus.connectionQuality}<br>
                ‚Ä¢ Should Show Warnings: ${networkStatus.shouldShowWarnings}
            `;
            
            document.getElementById('stats-result').innerHTML = `<div class="success-result">${statsHtml}</div>`;
        };

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                const className = type === 'error' ? 'error-result' : 
                                type === 'success' ? 'success-result' : 'test-result';
                element.innerHTML = `<div class="${className}">${message}</div>`;
            }
        }

        // Auto-run basic tests on load
        console.log('Asset Loading Error Handling Test Page Loaded');
        console.log('AssetLoader initialized:', !!assetLoader);
        console.log('NetworkMonitor initialized:', !!networkMonitor);
    </script>
</body>
</html>