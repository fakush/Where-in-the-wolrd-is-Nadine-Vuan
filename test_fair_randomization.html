<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fair Randomization System Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #001100;
            border: 2px solid #0f0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid;
        }
        .pass { border-color: #0f0; background: #001100; }
        .fail { border-color: #f00; background: #110000; color: #f00; }
        .info { border-color: #ff0; background: #111100; color: #ff0; }
        .warning { border-color: #f80; background: #110800; color: #f80; }
        .stats-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #0f0;
            padding: 8px;
            text-align: left;
        }
        .stats-table th {
            background: #002200;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        button:hover {
            background: #2f2;
        }
        .progress {
            background: #333;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #0f0;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ² Fair Randomization System Test</h1>
        <p>Testing the fairness and balance of the randomization system for "Where in the World is Nadine Vuan?"</p>

        <div class="test-section">
            <h2>Test Controls</h2>
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="runStartingCityTest()">Test Starting City Fairness</button>
            <button onclick="runRouteGenerationTest()">Test Route Generation</button>
            <button onclick="runSystemValidation()">Validate System</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div class="test-section">
            <h2>Test Progress</h2>
            <div id="progress-container" style="display: none;">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <p id="progress-text">Initializing tests...</p>
            </div>
        </div>

        <div class="test-section">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h2>Fairness Statistics</h2>
            <div id="fairness-stats"></div>
        </div>

        <div class="test-section">
            <h2>System Validation</h2>
            <div id="system-validation"></div>
        </div>
    </div>

    <!-- Import game modules -->
    <script type="module">
        import { GameController } from './src/modules/GameController.js';
        import { RandomizationSystem } from './src/modules/RandomizationSystem.js';

        let gameController;
        let testResults = [];

        // Initialize game controller
        async function initializeGame() {
            try {
                gameController = new GameController();
                await gameController.init();
                addResult('Game controller initialized successfully', 'pass');
                return true;
            } catch (error) {
                addResult(`Failed to initialize game controller: ${error.message}`, 'fail');
                return false;
            }
        }

        // Add test result to display
        function addResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            document.getElementById('test-results').appendChild(resultDiv);
            
            testResults.push({ message, type, timestamp: new Date() });
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Update progress bar
        function updateProgress(percent, text) {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = `${percent}%`;
            progressText.textContent = text;
            
            if (percent >= 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        // Run all randomization tests
        window.runAllTests = async function() {
            clearResults();
            addResult('Starting comprehensive randomization tests...', 'info');
            
            updateProgress(0, 'Initializing game system...');
            
            const initialized = await initializeGame();
            if (!initialized) {
                addResult('Cannot proceed with tests - initialization failed', 'fail');
                return;
            }
            
            updateProgress(20, 'Testing starting city fairness...');
            await runStartingCityTest();
            
            updateProgress(50, 'Testing route generation fairness...');
            await runRouteGenerationTest();
            
            updateProgress(80, 'Validating system integrity...');
            await runSystemValidation();
            
            updateProgress(100, 'All tests completed!');
            
            // Generate summary
            generateTestSummary();
        };

        // Test starting city selection fairness
        window.runStartingCityTest = async function() {
            if (!gameController) {
                const initialized = await initializeGame();
                if (!initialized) return;
            }

            addResult('Testing starting city selection fairness...', 'info');
            
            try {
                const results = gameController.testStartingCityFairness(100);
                
                if (results.error) {
                    addResult(`Starting city test failed: ${results.error}`, 'fail');
                    return;
                }
                
                // Display results
                addResult(`Starting city fairness test completed (${results.iterations} iterations)`, 'pass');
                addResult(`Fairness score: ${(results.fairnessScore * 100).toFixed(1)}%`, 
                    results.isBalanced ? 'pass' : 'warning');
                
                if (results.errors.length > 0) {
                    addResult(`Errors encountered: ${results.errors.length}`, 'warning');
                    results.errors.slice(0, 3).forEach(error => {
                        addResult(`  - ${error}`, 'warning');
                    });
                }
                
                // Create statistics table
                displayStartingCityStats(results);
                
            } catch (error) {
                addResult(`Starting city test error: ${error.message}`, 'fail');
            }
        };

        // Test route generation fairness
        window.runRouteGenerationTest = async function() {
            if (!gameController) {
                const initialized = await initializeGame();
                if (!initialized) return;
            }

            addResult('Testing route generation fairness...', 'info');
            
            try {
                const results = gameController.testRouteGenerationFairness(50);
                
                if (results.error) {
                    addResult(`Route generation test failed: ${results.error}`, 'fail');
                    return;
                }
                
                // Display results
                addResult(`Route generation test completed (${results.iterations} iterations)`, 'pass');
                addResult(`Fairness score: ${(results.fairnessScore * 100).toFixed(1)}%`, 
                    results.isBalanced ? 'pass' : 'warning');
                addResult(`Valid routes: ${results.routeValidations.valid}/${results.iterations}`, 
                    results.routeValidations.valid === results.iterations ? 'pass' : 'warning');
                
                if (results.errors.length > 0) {
                    addResult(`Errors encountered: ${results.errors.length}`, 'warning');
                    results.errors.slice(0, 3).forEach(error => {
                        addResult(`  - ${error}`, 'warning');
                    });
                }
                
                // Create statistics table
                displayRouteGenerationStats(results);
                
            } catch (error) {
                addResult(`Route generation test error: ${error.message}`, 'fail');
            }
        };

        // Validate randomization system
        window.runSystemValidation = async function() {
            if (!gameController) {
                const initialized = await initializeGame();
                if (!initialized) return;
            }

            addResult('Validating randomization system integrity...', 'info');
            
            try {
                const validation = gameController.validateRandomizationSystem();
                
                // Display validation results
                addResult(`System integrity: ${validation.overallValid ? 'VALID' : 'INVALID'}`, 
                    validation.overallValid ? 'pass' : 'fail');
                
                // System integrity details
                if (validation.systemIntegrity) {
                    addResult(`Random number generation: ${validation.systemIntegrity.isValid ? 'OK' : 'FAILED'}`, 
                        validation.systemIntegrity.isValid ? 'pass' : 'fail');
                    
                    validation.systemIntegrity.errors.forEach(error => {
                        addResult(`  - ${error}`, 'fail');
                    });
                    
                    validation.systemIntegrity.warnings.forEach(warning => {
                        addResult(`  - ${warning}`, 'warning');
                    });
                }
                
                // Game data compatibility
                if (validation.gameDataCompatibility) {
                    addResult(`Game data compatibility: ${validation.gameDataCompatibility.isValid ? 'OK' : 'FAILED'}`, 
                        validation.gameDataCompatibility.isValid ? 'pass' : 'fail');
                    
                    validation.gameDataCompatibility.errors.forEach(error => {
                        addResult(`  - ${error}`, 'fail');
                    });
                    
                    validation.gameDataCompatibility.warnings.forEach(warning => {
                        addResult(`  - ${warning}`, 'warning');
                    });
                }
                
                // Integration status
                if (validation.integrationStatus) {
                    addResult(`System integration: ${validation.integrationStatus.isValid ? 'OK' : 'FAILED'}`, 
                        validation.integrationStatus.isValid ? 'pass' : 'fail');
                    
                    validation.integrationStatus.errors.forEach(error => {
                        addResult(`  - ${error}`, 'fail');
                    });
                    
                    validation.integrationStatus.warnings.forEach(warning => {
                        addResult(`  - ${warning}`, 'warning');
                    });
                }
                
                // Display system validation details
                displaySystemValidation(validation);
                
            } catch (error) {
                addResult(`System validation error: ${error.message}`, 'fail');
            }
        };

        // Display starting city statistics
        function displayStartingCityStats(results) {
            const statsDiv = document.getElementById('fairness-stats');
            
            let html = '<h3>Starting City Selection Statistics</h3>';
            html += '<table class="stats-table">';
            html += '<tr><th>City ID</th><th>Selections</th><th>Percentage</th><th>Expected</th><th>Deviation</th></tr>';
            
            const totalSelections = Object.values(results.selections).reduce((sum, count) => sum + count, 0);
            const expectedPerCity = totalSelections / Object.keys(results.selections).length;
            
            Object.entries(results.selections).forEach(([cityId, count]) => {
                const percentage = totalSelections > 0 ? (count / totalSelections * 100).toFixed(1) : 0;
                const deviation = Math.abs(count - expectedPerCity).toFixed(1);
                
                html += `<tr>`;
                html += `<td>${cityId}</td>`;
                html += `<td>${count}</td>`;
                html += `<td>${percentage}%</td>`;
                html += `<td>${expectedPerCity.toFixed(1)}</td>`;
                html += `<td>${deviation}</td>`;
                html += `</tr>`;
            });
            
            html += '</table>';
            html += `<p><strong>Fairness Score:</strong> ${(results.fairnessScore * 100).toFixed(1)}%</p>`;
            html += `<p><strong>Balance Status:</strong> ${results.isBalanced ? 'BALANCED' : 'UNBALANCED'}</p>`;
            
            statsDiv.innerHTML = html;
        }

        // Display route generation statistics
        function displayRouteGenerationStats(results) {
            const statsDiv = document.getElementById('fairness-stats');
            
            let html = statsDiv.innerHTML + '<h3>Route Generation Statistics</h3>';
            html += '<table class="stats-table">';
            html += '<tr><th>City ID</th><th>Appearances</th><th>Percentage</th><th>Expected</th><th>Deviation</th></tr>';
            
            const totalAppearances = Object.values(results.cityAppearances).reduce((sum, count) => sum + count, 0);
            const expectedPerCity = totalAppearances / Object.keys(results.cityAppearances).length;
            
            Object.entries(results.cityAppearances).forEach(([cityId, count]) => {
                const percentage = totalAppearances > 0 ? (count / totalAppearances * 100).toFixed(1) : 0;
                const deviation = Math.abs(count - expectedPerCity).toFixed(1);
                
                html += `<tr>`;
                html += `<td>${cityId}</td>`;
                html += `<td>${count}</td>`;
                html += `<td>${percentage}%</td>`;
                html += `<td>${expectedPerCity.toFixed(1)}</td>`;
                html += `<td>${deviation}</td>`;
                html += `</tr>`;
            });
            
            html += '</table>';
            html += `<p><strong>Route Fairness Score:</strong> ${(results.fairnessScore * 100).toFixed(1)}%</p>`;
            html += `<p><strong>Valid Routes:</strong> ${results.routeValidations.valid}/${results.iterations}</p>`;
            
            statsDiv.innerHTML = html;
        }

        // Display system validation details
        function displaySystemValidation(validation) {
            const validationDiv = document.getElementById('system-validation');
            
            let html = '<h3>Randomization System Validation Details</h3>';
            
            // Overall status
            html += `<p><strong>Overall Status:</strong> <span class="${validation.overallValid ? 'pass' : 'fail'}">${validation.overallValid ? 'VALID' : 'INVALID'}</span></p>`;
            
            // System integrity
            if (validation.systemIntegrity) {
                html += '<h4>System Integrity</h4>';
                html += `<p>Status: <span class="${validation.systemIntegrity.isValid ? 'pass' : 'fail'}">${validation.systemIntegrity.isValid ? 'VALID' : 'INVALID'}</span></p>`;
                
                if (validation.systemIntegrity.errors.length > 0) {
                    html += '<p><strong>Errors:</strong></p><ul>';
                    validation.systemIntegrity.errors.forEach(error => {
                        html += `<li class="fail">${error}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (validation.systemIntegrity.warnings.length > 0) {
                    html += '<p><strong>Warnings:</strong></p><ul>';
                    validation.systemIntegrity.warnings.forEach(warning => {
                        html += `<li class="warning">${warning}</li>`;
                    });
                    html += '</ul>';
                }
            }
            
            // Game data compatibility
            if (validation.gameDataCompatibility) {
                html += '<h4>Game Data Compatibility</h4>';
                html += `<p>Status: <span class="${validation.gameDataCompatibility.isValid ? 'pass' : 'fail'}">${validation.gameDataCompatibility.isValid ? 'VALID' : 'INVALID'}</span></p>`;
                
                if (validation.gameDataCompatibility.errors.length > 0) {
                    html += '<p><strong>Errors:</strong></p><ul>';
                    validation.gameDataCompatibility.errors.forEach(error => {
                        html += `<li class="fail">${error}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (validation.gameDataCompatibility.warnings.length > 0) {
                    html += '<p><strong>Warnings:</strong></p><ul>';
                    validation.gameDataCompatibility.warnings.forEach(warning => {
                        html += `<li class="warning">${warning}</li>`;
                    });
                    html += '</ul>';
                }
            }
            
            validationDiv.innerHTML = html;
        }

        // Generate test summary
        function generateTestSummary() {
            const passCount = testResults.filter(r => r.type === 'pass').length;
            const failCount = testResults.filter(r => r.type === 'fail').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            addResult('='.repeat(50), 'info');
            addResult('TEST SUMMARY', 'info');
            addResult(`Total Tests: ${testResults.length}`, 'info');
            addResult(`Passed: ${passCount}`, passCount > 0 ? 'pass' : 'info');
            addResult(`Failed: ${failCount}`, failCount > 0 ? 'fail' : 'info');
            addResult(`Warnings: ${warningCount}`, warningCount > 0 ? 'warning' : 'info');
            
            const successRate = testResults.length > 0 ? (passCount / testResults.length * 100).toFixed(1) : 0;
            addResult(`Success Rate: ${successRate}%`, successRate >= 80 ? 'pass' : successRate >= 60 ? 'warning' : 'fail');
            addResult('='.repeat(50), 'info');
        }

        // Clear test results
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('fairness-stats').innerHTML = '';
            document.getElementById('system-validation').innerHTML = '';
            testResults = [];
            updateProgress(0, 'Ready to run tests...');
        };

        // Initialize on page load
        window.addEventListener('load', () => {
            addResult('Fair Randomization Test Suite loaded', 'info');
            addResult('Click "Run All Tests" to begin comprehensive testing', 'info');
        });
    </script>
</body>
</html>